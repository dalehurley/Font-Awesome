<?php
/**
 * Launch this script in command line
 * 
 */

include ('cliColors.class.php');
$colors = new Colors(); // appel object colorisation

// recup hostname
//$hostname = $_SERVER["HOSTNAME"];
//echo $colors->getColoredString("  Hostname : ".$hostname, "dark_gray", "yellow") . "  \n";

/************************ parametres (no need, all in argv) **************************************/
// switch ($hostname) {
// 	case 'fedoralionel':
// 		$dirContentSite = "/data/www";
// 		$dirBE = "/data/www/base-editoriale";   
// 		break;

// 	case 'productionvm15':
// 		$dirContentSite = "/data/www/sitesv3";
// 		$dirBE = "data/www/sitesv3/_system_base-editoriale";  // serveur de prod
// 		break;

// 	default:
// 		$dirContentSite = "";
// 		$dirBE = "";  
// 		break;
// }


/**************************************************************************/

$utilisation = 
<<<EOF
         
 Utilisation : php controls argument1 argument2 argument3 [auto] [quiet]                                      
          
  * argument1 : le dossier contenant du(des) site(s) [exemple: /data/www ]    
  * argument2 : le(s) dossier(s) du(des) site(s) [exemples: IM* , _demo_ec-tenor, _demo_* ]     
  * argument3 : la commande                                                
      --help                aide                                                        
      dumps                 sauvegarde en dump 
      dumps-with-settings        sauvegarde en dump (avec config dm_setting)
      loadArticles          charge les sections puis les articles
      search-update         met à jour lucene (index de recherche)
      sitemap-update        met à jour le sitemap
      setup                 effectue un dm:setup
      loadBE                met à jour la base éditoriale
      ccc                   purge du cache web et APC
      less-compile          compilation des fichiers less
      generate-sprite       génération des sprites
      migration-doctrine    effectue une migration doctrine suivi d'un dm:setup
      infos                 donne des infos 
  * argument4 (optionnel) : 
      auto                  mode automatique (sans validation des sites à traiter) 
  * argument5 (optionnel) : 
      quiet                 mode silencieux (pas complètement...)       

EOF;
$help = $colors->getColoredString($utilisation, "green") . "\n";

// verification 3 arguments
if (count($argv)<4 || $argv[0]!='controls'){
	echo $colors->error("  ERREUR : il y a 3 arguments obligatoires");
	echo $help;
	exit;
}
// verification arg 1 is dir
if (!is_dir($argv[1])){
	echo $colors->error("  ERREUR : l'argument 1 doit être un répertoire valide ");
	echo $help;
	exit;
}


// récupération des 3 arguments
// le dossier contenant du site
$dirContentSite = $argv[1];
echo $colors->info("  Dossier contenant : ".$dirContentSite." ");
// le dossier du site
$dirSite = $argv[2];
echo $colors->info("  Dossier site : ".$dirSite." ");
// la commande choisie
$argCommande = $argv[3]; 
echo $colors->info("  Commande : ".$argCommande." ");
// arguement 4 optionnel
if (isset($argv[4]) && $argv[4]=='auto'){
	$interactiveMode = false;
} else {
	$interactiveMode = true;
}
// arguement 5 optionnel
if (isset($argv[5]) && $argv[5]=='quiet'){
	$quietMode = true;
} else {
	$quietMode = false;
}

switch ($argCommande) {
	case '--help':
		echo $help;
		break;

	case 'dumps':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony db:dump --auto=true";
		commandForAllSites($commande);
		break;

	case 'dumps-with-settings':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony db:dump --settings=true --auto=true";
		commandForAllSites($commande);
		break;		

	case 'loadArticles':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony be:loadArticles sections;php symfony be:loadArticles articles;";
		commandForAllSites($commande);
		break;

	case 'search-update':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony dm:search-update;";
		commandForAllSites($commande);
		break;

	case 'sitemap-update':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony dm:sitemap-update;";
		commandForAllSites($commande);
		break;

	case 'setup':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony dm:setup;";
		commandForAllSites($commande);
		break;

	case 'loadBE':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony be:loadBE verbose --auto=true";
		commandForAllSites($commande);
		break;

    // ccc                   purge du cache web et APC
    // less-compile          compilation des fichiers less
    // generate-sprite       génération des sprites
    // migration-doctrine    effectue une migration doctrine suivi d'un dm:setup
    // infos                 donne des infos 

	case 'ccc':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony ccc";
		commandForAllSites($commande);
		break;

	case 'less-compile':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony less:compile-all";
		commandForAllSites($commande);
		break;

	case 'generate-sprite':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony less:sprite";
		commandForAllSites($commande);
		break;

	case 'migration-doctrine':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony doctrine:generate-migrations-diff;php symfony doctrine:migrate;php symfony dm:setup;";
		commandForAllSites($commande);
		break;

	case 'infos-site':
		$commande = "cd ".$dirContentSite."/##DIRSITE##;php symfony dm:infos-site;";
		commandForAllSites($commande);
		break;

	default:
		echo $help; 
		break;
}



/**
 * execute une commande pour les sites d'un dossier donné
 * @param  [type] $command  [description]
 * @param  [type] $dirContentSite [description]
 * @return [type]           [description]
 */
function commandForAllSites($commande){
	
	global $interactiveMode;
	global $quietMode;
	global $dirContentSite;
	global $dirSite;
	global $argCommande;

	$colors = new Colors(); // appel object colorisation

	$dirContent = opendir($dirContentSite); 


	$allSiteBeginTime = microtime(true);
	$nbATraiter = 0;
	while($dir = readdir($dirContent)) {
		
		$aTraiter = false;
		if (substr($dirSite,-1) == '*'){
			if(substr($dir,0,strlen($dirSite)-1) == substr($dirSite,0,-1) && is_dir($dirContentSite.'/'.$dir)) {
				$aTraiter = true;
			}
		} else {
			if($dir == $dirSite && is_dir($dirContentSite.'/'.$dir)) {
				$aTraiter = true;
			}
		}

		if($aTraiter) {
			$sfFilename = $dirContentSite.'/'.$dir.'/symfony';
			if (is_file($sfFilename)){
				$nbATraiter ++;
				//echo $colors->important("A traiter > ". $dirContentSite.'/'.$dir);
				$interactiveValidation = true;  // validation humaine à vrai par défaut
				if ($interactiveMode){
					echo $colors->question("Pour le site ".$dirContentSite.'/'.$dir." souhaitez vous effectuer la commande ".$argCommande."? (oui/non)");
					$handle = fopen ("php://stdin","r");
					$line = fgets($handle);
					if(trim($line) != 'oui'){
					    $interactiveValidation = false;
					}
				} 
				if ($interactiveValidation){ // on traite si la validation humaine est faite
					$siteBeginTime = microtime(true);
				 	if (!$quietMode) {
				 		echo $colors->important("  Début de traitement du site ".$dirContentSite.'/'.$dir." : ".$argCommande." ");
				 	} else {
				 		echo $colors->important("Site ".$dirContentSite.'/'.$dir." ");
				 	}
				 	$commandToRun = str_replace('##DIRSITE##', $dir, $commande);
				 	
				 	$result = array();
				 	exec($commandToRun, $result);
				 	foreach ($result as $key => $value) {
				 		echo $colors->help($value);
				 	}

				 	if (!$quietMode) echo $colors->info("Commande effectuée : ". $commandToRun);
				 	$dureeSite = microtime(true) - $siteBeginTime. " s";
				 	if (!$quietMode) echo $colors->important("  Fin de traitement du site ".$dirContentSite.'/'.$dir." : ".$argCommande." (".$dureeSite.")")."\n";
				}
			} else {
				echo $colors->error("Site ".$dirContentSite.'/'.$dir." invalide : fichier ". $sfFilename." absent...");
			}
		} 
	}

	$dureeAllSite = microtime(true) - $allSiteBeginTime. " s";

	closedir($dirContent);

	if (!$nbATraiter) {
		echo $colors->error("Pas de site correspondant aux arguments...");
	} else {
		$libATraiter = ($nbATraiter>0)?" sites ont été traités ":" site a été traité ";
		echo $colors->important(" \n  INFOS : ".$nbATraiter.$libATraiter." en ".$dureeAllSite." \n ");	
	}
	
}


?>